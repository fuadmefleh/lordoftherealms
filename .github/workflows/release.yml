name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v0.3.0, v1.0.0, etc.

permissions:
  contents: write  # Required to create releases

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build game data
        run: npm run build:data

      - name: Run tests
        run: npm test

  build-windows-exe:
    name: Build Windows Installer
    needs: test
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Get version from tag
        id: version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          if [[ $VERSION =~ -(alpha|beta|rc) ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Build game data
        run: npm run build:data

      - name: Build Electron app
        run: npm run dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Windows installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            dist/*.exe
          retention-days: 5

  build-and-release:
    name: Build and Create Release
    needs: [test, build-windows-exe]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Detect if this is a pre-release based on version string
          if [[ $VERSION =~ -(alpha|beta|rc) ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "üì¶ Detected pre-release version: $VERSION"
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "üì¶ Detected stable release version: $VERSION"
          fi
      
      - name: Download Windows installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: dist-win

      - name: Build game data
        run: npm run build:data

      - name: Build for production
        run: npm run build

      - name: Create release bundle
        run: |
          # Create a directory for the release
          mkdir -p release/lord-of-the-realms-${{ steps.version.outputs.version }}
          
          # Copy Vite build output + runtime data
          cp -r dist-web/* release/lord-of-the-realms-${{ steps.version.outputs.version }}/
          cp -r assets release/lord-of-the-realms-${{ steps.version.outputs.version }}/
          cp -r data release/lord-of-the-realms-${{ steps.version.outputs.version }}/
          cp README.md release/lord-of-the-realms-${{ steps.version.outputs.version }}/
          cp LICENSE release/lord-of-the-realms-${{ steps.version.outputs.version }}/ 2>/dev/null || echo "No LICENSE file found"
          
          # Create zip archive
          cd release
          zip -r lord-of-the-realms-${{ steps.version.outputs.version }}.zip lord-of-the-realms-${{ steps.version.outputs.version }}
          cd ..
          
          echo "Release bundle created successfully"
      
      - name: Generate release notes
        id: release_notes
        run: |
          cat << 'EOF' > release_notes.md
          ## Lord of the Realms ${{ steps.version.outputs.version }}
          
          ### üéÆ How to Play
          
          #### Windows Installer (Recommended)
          1. Download **Lord.of.the.Realms.Setup.*.exe** below
          2. Run the installer
          3. Launch "Lord of the Realms" from your Start Menu or Desktop shortcut
          
          #### Browser Version
          1. Download the **lord-of-the-realms-*.zip** file below
          2. Extract the archive
          3. Serve the folder with any static HTTP server (e.g. `npx serve .`)
          4. Open the URL in your browser
          
          ### üì¶ What's Included
          
          - **Windows Installer** ‚Äî standalone desktop app, no browser needed
          - **Browser Bundle** ‚Äî play in any modern web browser
          - All assets, data, and game logic
          - Documentation and README
          
          ### üêõ Issues & Feedback
          
          Found a bug or have a suggestion? Please [open an issue](https://github.com/${{ github.repository }}/issues).
          
          ---
          
          *Rise from Nothing. Forge Your Legacy.*
          EOF
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Lord of the Realms ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            release/lord-of-the-realms-${{ steps.version.outputs.version }}.zip
            dist-win/*.exe
          draft: false
          prerelease: ${{ steps.version.outputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Release completed
        run: |
          echo "‚úÖ Release ${{ steps.version.outputs.version }} has been published!"
          echo "üéâ Download link: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
